<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Weatherfunctions • Weatherfunctions</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Weatherfunctions">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Weatherfunctions</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/Weatherfunctions.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Weatherfunctions</h1>
            
      

      <div class="d-none name"><code>Weatherfunctions.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://henningkage.github.io/Weatherfunctions/">Weatherfunctions</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringi.gagolewski.com/" class="external-link">stringi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RCurl</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.fstpackage.org" class="external-link">fst</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/" class="external-link">httr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="intro">Intro<a class="anchor" aria-label="anchor" href="#intro"></a>
</h2>
<p>The German Weather Service (DWD) supplies weather data in different
spatial and time resolution and from different types of weather
stations. This package aims to a) assist in retrieving this data in a
first step to a local copy of the data and b) in a second step to
prepare the data for simulations and other purposes. Thereby especially
the estimation of global radiation data from sunshine hours is supported
and interpolation for certain locations based on distance weighted use
of the nearest weather station is possible.</p>
<div class="section level3">
<h3 id="structure-of-dwd-ftp-service">Structure of DWD ftp service<a class="anchor" aria-label="anchor" href="#structure-of-dwd-ftp-service"></a>
</h3>
<div class="section level4">
<h4 id="daily-observations-of-weather-data">Daily observations of weather data<a class="anchor" aria-label="anchor" href="#daily-observations-of-weather-data"></a>
</h4>
<p>The daily observations of weather data from the stations are divided
into two sections, historical data which passed a quality control and
recent data, not yet full controlled and usually containing the data of
the actual and the data of the previous year. Their actuality is usually
one day back, so that the observations from the last day are available
on the next day. For convenience the link to these repositories and
their local copies as well as already transformed data is stored in
variable defined in the package. For the historical data the variable
“DWD_ftp_historical” is defined containing the link to <a href="ftp://opendata.dwd.de/climate_environment/CDC/observations_germany/climate/daily/kl/historical/" class="uri">ftp://opendata.dwd.de/climate_environment/CDC/observations_germany/climate/daily/kl/historical/</a>
and for the recent data the variable “DWD_ftp_recent” with the link to
<a href="ftp://opendata.dwd.de/climate_environment/CDC/observations_germany/climate/daily/kl/recent/" class="uri">ftp://opendata.dwd.de/climate_environment/CDC/observations_germany/climate/daily/kl/recent/</a>.
Also of interest are the directories with additional precipitation data
and solar radiation data which are available only for a limited number
of stations in Germany. There is also a directory with selected long
term observations from selected stations (timeseries_overview):</p>
<pre><code>├───kl
│   ├───historical
│   └───recent
├───more_precip
│   ├───historical
│   └───recent
├───solar
└───timeseries_overview</code></pre>
<p>In order to reduce the number of file transfers when using these data
it is convenient to make local copies of the DWD data. The package
defines a directory after installation were the downloads data are
saved. It further defines strings to the copies of recent and historical
DWD data
/home/runner/.local/share/R/Weatherfunctions/LocalCopyDWD/kl/historical.
Depending on the local machine, the directory differs, for this machine
the directory is: /home/runner/.local/share/R/Weatherfunctions and can
be retrieved by the command: tools::R_user_dir(“Weatherfunctions”,
which=“data”).</p>
</div>
</div>
<div class="section level3">
<h3 id="structure-of-dwd-data-files">Structure of DWD data files<a class="anchor" aria-label="anchor" href="#structure-of-dwd-data-files"></a>
</h3>
<p>The data for the recent and historic observations are stored in ZIP
files, one for each station, which contain a number of files with meta
data and a data file (Example:
produkt_klima_tag_20211123_20230526_00164.txt) were the filename
consists of a string constant “produkt_klima_tag” two strings with the
date of the first and the last observation day in the file in the format
yyyymmdd and the Stations_id of the station as a 5 char string with
leading zeros.</p>
</div>
<div class="section level3">
<h3 id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a>
</h3>
<div class="section level4">
<h4 id="get-the-station-meta-data-getdwdcontent">Get the station meta data (getDWDContent)<a class="anchor" aria-label="anchor" href="#get-the-station-meta-data-getdwdcontent"></a>
</h4>
<p>The function “getDWDContent” reads the content of the DWD ftp server
and returns a data frame with the station meta data. The function is
used to get the station meta data for the historical and recent
observations.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">DWDhistorical</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getDWDContent.html">getDWDContent</a></span><span class="op">(</span><span class="va">DWD_ftp_historical</span><span class="op">)</span></span>
<span><span class="va">DWDrecent</span>     <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getDWDContent.html">getDWDContent</a></span><span class="op">(</span><span class="va">DWD_ftp_recent</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">DWDhistorical</span><span class="op">)</span></span></code></pre></div>
<p>The function returns a list with the following elements:</p>
<ul>
<li>“stationlist” a data frame with the station meta data</li>
<li>“filelist” a string array with the filenames of the meta data
files</li>
<li>“ziplist” a list of the ZIP files for the stations</li>
<li>“zipID” a list of the station IDs</li>
</ul>
</div>
<div class="section level4">
<h4 id="meta-data-for-additional-precipitation-stations">Meta data for additional precipitation stations<a class="anchor" aria-label="anchor" href="#meta-data-for-additional-precipitation-stations"></a>
</h4>
<p>For the additional data from stations measuring precipitation data
the function “getDWDContent” has to be called with the respective
parameters.</p>
<p>The DWD records for historical observations consists of data r
nHistoricalStationlist different historical stations (which changed over
time) and for the recent observations of values of r nRecentStationlist
stations.</p>
</div>
<div class="section level4">
<h4 id="retrieving-the-combined-recent-historic-information-getdwdstationlist">Retrieving the combined (recent &amp; historic) information
(getDWDStationList)<a class="anchor" aria-label="anchor" href="#retrieving-the-combined-recent-historic-information-getdwdstationlist"></a>
</h4>
<p>The function getDWDStationList retrieves the information (meta data)
for both, recent and historic directories. The function returns a
compiled data frame containing all station parameters (“stations”) as
well as the lists of the historical and recent weather station
information the function “getDWDContent” returns (see section
above).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DWD_content</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getDWDStationList.html">getDWDStationList</a></span><span class="op">(</span>historical <span class="op">=</span> <span class="va">DWD_ftp_historical</span>, recent <span class="op">=</span> <span class="va">DWD_ftp_recent</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">DWD_content</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="make-a-local-copy-of-dwd-observation-data-copy_dwd_zipfiles">Make a local copy of DWD observation data (Copy_DWD_ZipFiles)<a class="anchor" aria-label="anchor" href="#make-a-local-copy-of-dwd-observation-data-copy_dwd_zipfiles"></a>
</h4>
<p>For the file transfer the package holds the function
“Copy_DWD_ZipFiles” for downloading the files to a local directory. For
the recent data the package defines the path
/home/runner/.local/share/R/Weatherfunctions/LocalCopyDWD/kl/recent and
for the historical data the path
/home/runner/.local/share/R/Weatherfunctions/LocalCopyDWD/kl/historical.</p>
<p>There are 500+ recent stations available and 1000+ data for recent
&amp; historic stations. So the download takes some time.</p>
<p>For a total download of the recent and historical data the function
“Copy_DWD_ZipFiles” the function has to be called with the respective
parameters twice.</p>
<p>For further processing of the data and to save disk space the data
can be saved in a more compact format using the function
“UpdateDWDData_to_fst”. The parameter isloadnew is used to load the data
from the DWD ftp server, if FALSE the local zip-files will be used, if
available. Again this process is time consuming, as the data is read
from the zip files and saved in a fst file. The parameter startdate is
used to define the start date of the data to be processed. The file size
may still be large, the data in fst format for the historical data from
1970 on is about 1 GB.</p>
</div>
</div>
<div class="section level3">
<h3 id="download-dwd-data">Download DWD data<a class="anchor" aria-label="anchor" href="#download-dwd-data"></a>
</h3>
<p>The package Weatherfunctions provides functions to download the data
from the DWD ftp server or its local copy.</p>
<div class="section level4">
<h4 id="data-for-a-single-weather-station-recent-or-historical-getsingledwdweather">Data for a single weather station recent or historical
(getsingleDWDWeather)<a class="anchor" aria-label="anchor" href="#data-for-a-single-weather-station-recent-or-historical-getsingledwdweather"></a>
</h4>
<p>The data from the DWD repository or its local copy can be downloaded
either from the historic or recent data repositories which can be the
DWD ftp service or its local copy using the function
getsingleDWDWeather.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selstation</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">DWD_content</span><span class="op">$</span><span class="va">recent</span><span class="op">$</span><span class="va">zipID</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">recent_data</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">recent_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getsingleDWDWeather.html">getsingleDWDWeather</a></span><span class="op">(</span>station <span class="op">=</span> <span class="va">selstation</span>, ziplist <span class="op">=</span> <span class="va">DWD_content</span><span class="op">$</span><span class="va">recent</span><span class="op">$</span><span class="va">ziplist</span>,</span>
<span>                            repository <span class="op">=</span> <span class="va">DWD_ftp_recent</span>, local <span class="op">=</span> <span class="cn">F</span>, quiet <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selstation</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">DWDRain_content</span><span class="op">$</span><span class="va">recent</span><span class="op">$</span><span class="va">zipID</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getsingleDWDRain.html">getsingleDWDRain</a></span><span class="op">(</span>station <span class="op">=</span> <span class="va">selstation</span>, ziplist <span class="op">=</span> <span class="va">DWDRain_content</span><span class="op">$</span><span class="va">recent</span><span class="op">$</span><span class="va">ziplist</span>,</span>
<span>                            repository <span class="op">=</span> <span class="va">DWDRain_ftp_recent</span>, local <span class="op">=</span> <span class="cn">F</span>, quiet <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">recent_data</span><span class="op">)</span></span></code></pre></div>
<p>In addition to the data from
produkt_klima_tag_YYYYMMDD_YYYYMMDD_nnnnn.txt, the measurement height of
wind speed was retrieved from the metadata file of the selected weather
stations and a Date column is added in R format.</p>
<p>Note that the windspeed data is given for a height of 10 m above
ground level. If wind speed was measured at a different height the
correction is made with the function “windheight”.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>u</mi><mi>o</mi></msub><mo>=</mo><msub><mi>u</mi><mi>i</mi></msub><mo>⋅</mo><mfrac><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>67.8</mn><mo>⋅</mo><msub><mi>z</mi><mi>o</mi></msub><mo>−</mo><mn>5.42</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>67.8</mn><mo>*</mo><msub><mi>z</mi><mi>i</mi></msub><mo>−</mo><mn>5.42</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">u_o = u_i \cdot \frac{ log(67.8 \cdot z_o - 5.42)} { log(67.8 * z_i - 5.42)}</annotation></semantics></math></p>
<p>The downloaded data have column names according to the code of DWD,
for which in a first step also readable names are defined. in the data
frame df_names_DWD.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_names_DWD</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="download-combined-data-getcombineddwdweather">Download combined data (getcombinedDWDWeather)<a class="anchor" aria-label="anchor" href="#download-combined-data-getcombineddwdweather"></a>
</h4>
<p>For downloading the combination of historic and recent weather data
of a particular station the function “getcombinedDWDWeather” can be
used. It also adds station information to the returned data frame.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selstation</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">DWD_content</span><span class="op">$</span><span class="va">recent</span><span class="op">$</span><span class="va">zipID</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getcombinedDWDWeather.html">getcombinedDWDWeather</a></span><span class="op">(</span>DWD_content <span class="op">=</span> <span class="va">DWD_content</span>, station <span class="op">=</span> <span class="va">selstation</span>,</span>
<span>                              recent_repository <span class="op">=</span> <span class="va">DWD_ftp_recent</span>, historical_repository <span class="op">=</span> <span class="va">DWD_ftp_historical</span>, local <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rename.weather.html">rename.weather</a></span><span class="op">(</span><span class="va">combined_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">combined_data</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="add-radiation-data-getradweather">Add radiation data (getRadWeather)<a class="anchor" aria-label="anchor" href="#add-radiation-data-getradweather"></a>
</h3>
<p>The function getRadWeather uses the DWD-data in long name format and
adds several derived parameters.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RadWeather</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">RadWeather</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getRadWeather.html">getRadWeather</a></span><span class="op">(</span><span class="va">combined_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">RadWeather</span><span class="op">)</span></span></code></pre></div>
<p>The additional columns are DOY: day of year, Dayl: daylength in
hours, Angot: maximum possible radiation outside atmosphere
[MJ.m-2.d-1], RelSun: the relative sunshine hours on that day, Monat:
the calendar month of the day, , EstGlobRad the estimated global
radiation of the day, ExcelTime: the day of year in Excel format, VP:
the average vapour pressure on the day [mBar], the saturation deficit of
the air and Ra_Int, the radiation intensity in [W.m-2]. The functions
uses other functions from the package and external functions to
calculate some of these parameters. <em>Calcsolar (dayofyear,
latitude)</em> calculates the daylength and the angot value. The
function <em>relrad(RelSun, Month)</em> calculates the relative
radiation compared to the angot values of that day of year. The function
is based on an empirical regression between the relative radiation the
relative sunshine duration for different months in Germany based on DWD
data.</p>
</div>
<div class="section level3">
<h3 id="saving-data-to-local-files-in-fst-format-updatedwddata_to_fst">Saving data to local files in fst-format (UpdateDWDData_to_fst)<a class="anchor" aria-label="anchor" href="#saving-data-to-local-files-in-fst-format-updatedwddata_to_fst"></a>
</h3>
<p>In order to save the downloaded data in a more compact and
pre-computed format the function UpdateDWDData_to_fst can be used.The
parameter ‘<em>isloadnew</em>’ is used to load the data from the DWD ftp
server, if FALSE the local zip-files will be used, if available. This
again is a time consuming process, as the data is read from the zip
files and saved in a fst file. For further analysis it is often
sufficient to download the historical data only to the fst file, as
these data are updated only once a year.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/UpdateDWDData_to_fst.html">UpdateDWDData_to_fst</a></span><span class="op">(</span>dataperiod <span class="op">=</span> <span class="st">"recent"</span>, startdate <span class="op">=</span> <span class="st">"1990-01-01"</span>, isloadnew <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>A saved file can be read using the function read.fst from the package
fst.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="st">"recent_weather_dat_1990.fst"</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">Local_R_DWD</span>, <span class="va">fn</span>, sep<span class="op">=</span><span class="st">"/"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">weather_recent</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html" class="external-link">read.fst</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">path</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
<p>The function UpdateDWDData_to_fst can also be used to update the
historical data. This is done by setting the parameter dataperiod to
“historical” and the startdate to the first date of the data to be
downloaded. This process is time consuming and should be done only once
a year.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/UpdateDWDData_to_fst.html">UpdateDWDData_to_fst</a></span><span class="op">(</span>dataperiod <span class="op">=</span> <span class="st">"historical"</span>, startdate <span class="op">=</span> <span class="st">"1990-01-01"</span>, isloadnew <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="interpolation-of-weather-data-for-a-selected-location">Interpolation of weather data for a selected location<a class="anchor" aria-label="anchor" href="#interpolation-of-weather-data-for-a-selected-location"></a>
</h3>
<p>The algorithm is basically based on the approach to select for every
day and for every weather parameter the values of the 3 nearest
observations and to interpolate between those values according to
inverse distance weigthing.</p>
<p>Additionally the rainfall data of the nearest weather station
including the additional rainfall stations are used.</p>
<p>The function InterpolateFromDWD is used to interpolate the weather
data for a selected location. The procedure is split in two parts, first
the interpolation of the historical data and second the interpolation of
the recent data, finally the data is combined in one data frame.</p>
<p>The retrieval of the historical and - to a lesser extent - the recent
data is time consuming, as the data for each station has to be
downloaded as zip files and extracted. It is therefore more efficient to
pre download the data. The package supports two different approaches,
the first is to a fst file for further use. Here the the fst approach is
used.</p>
<div class="section level4">
<h4 id="retrieval-of-the-weather-data-for-interpolation">Retrieval of the weather data for interpolation<a class="anchor" aria-label="anchor" href="#retrieval-of-the-weather-data-for-interpolation"></a>
</h4>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co"># load historic weather data from local fst file ####</span></span>
<span><span class="co"># the filename is constructed from two strings for the actual path of the project</span></span>
<span><span class="co"># and a filename which are both pre defined.</span></span>
<span></span>
<span><span class="va">fn_histDWD_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">fn_histDWD_data_str</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">1970</span><span class="op">)</span>,<span class="st">".fst"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="va">Local_R_DWD</span>, <span class="va">fn_histDWD_data</span><span class="op">)</span></span>
<span><span class="va">weather_historic</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html" class="external-link">read.fst</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">fn</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select the columns that are in the core, i.e. essential data set and rename them</span></span>
<span><span class="va">weather_historic_core</span> <span class="op">&lt;-</span> <span class="va">weather_historic</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Stations_id"</span>, <span class="st">"Date"</span>,<span class="va">longNames_DWD_core</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">weather_historic</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># update the local weather data for the recent period ######################</span></span>
<span><span class="co"># and store them in a fst file</span></span>
<span><span class="co"># this has to be done only once per day</span></span>
<span><span class="co"># the data is stored in a fst file</span></span>
<span><span class="co"># and takes up to 10-15 minutes</span></span>
<span></span>
<span><span class="va">ThisYear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># take the data frame with meta data for recent stations to a separate variable</span></span>
<span><span class="va">RecentRainStationList</span> <span class="op">&lt;-</span> <span class="va">DWDRain_content</span><span class="op">$</span><span class="va">recent</span><span class="op">$</span><span class="va">stationlist</span></span>
<span></span>
<span><span class="va">UpdateRecentDWDdata</span> <span class="op">&lt;-</span> <span class="cn">F</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">UpdateRecentDWDdata</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">StartTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/UpdateDWDData_to_fst.html">UpdateDWDData_to_fst</a></span><span class="op">(</span>dataperiod <span class="op">=</span> <span class="st">"recent"</span>, </span>
<span>                       isloadnew <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                       DWD_content <span class="op">=</span> <span class="va">DWD_content</span>,</span>
<span>                       startdate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ThisYear</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,<span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">EndTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Time for UpdateDWDData_to_fst:"</span>, <span class="va">EndTime</span> <span class="op">-</span> <span class="va">StartTime</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">fn_recentDWD_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"recent_weather_dat_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">1990</span><span class="op">)</span>,<span class="st">".fst"</span><span class="op">)</span></span>
<span><span class="va">weather_recent</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html" class="external-link">read.fst</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="va">Local_R_DWD</span>, <span class="va">fn_recentDWD_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">weather_recent</span>  <span class="op">&lt;-</span> <span class="va">weather_recent</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Stations_id"</span>,<span class="st">"Date"</span>,<span class="va">longNames_DWD_core</span><span class="op">)</span><span class="op">]</span> </span>
<span></span>
<span><span class="co"># set the location of the station  </span></span>
<span>  <span class="va">geoBreite</span> <span class="op">&lt;-</span> <span class="fl">52.7306</span></span>
<span>  <span class="va">geoLaenge</span> <span class="op">&lt;-</span> <span class="fl">10.6298</span></span>
<span>  <span class="va">Hoehe_m</span> <span class="op">&lt;-</span> <span class="fl">85</span></span>
<span>  </span>
<span>  <span class="co"># make location data frame  </span></span>
<span>  <span class="va">Location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Latitude<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">geoBreite</span><span class="op">)</span>, Longitude<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">geoLaenge</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># make an sf object from Location data frame</span></span>
<span>  <span class="va">Location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">Location</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Longitude"</span>, <span class="st">"Latitude"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_set_crs</a></span><span class="op">(</span>value <span class="op">=</span> <span class="st">"+proj=longlat +datum=WGS84"</span><span class="op">)</span></span></code></pre></div>
<p>The historic weather data contains the data for the years 1990 to the
previous year and consists of r nrow(weather_historic_core) records. The
recent weather data contains the data for the years r ThisYear-1 to the
current year and consists of r nrow(weather_recent) records.</p>
</div>
<div class="section level4">
<h4 id="interpolation-of-the-historic-weather-data-for-the-location">Interpolation of the historic weather data for the location<a class="anchor" aria-label="anchor" href="#interpolation-of-the-historic-weather-data-for-the-location"></a>
</h4>
<p>In a next step the historic weather data is interpolated for the
location. If all gets ok then the data frame should have no NA
values.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span>  </span>
<span><span class="co">### interpolate the historic weather data for the location  </span></span>
<span>  </span>
<span>  <span class="co"># retrieve the recent station list from the DWD content</span></span>
<span>  <span class="va">stationlist</span> <span class="op">&lt;-</span> <span class="va">DWDhistorical</span><span class="op">$</span><span class="va">stationlist</span></span>
<span></span>
<span>  <span class="co"># make an sf object from stationlist data frame</span></span>
<span>  <span class="va">stationlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">stationlist</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geoLaenge"</span>, <span class="st">"geoBreite"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_set_crs</a></span><span class="op">(</span>value <span class="op">=</span> <span class="st">"+proj=longlat +datum=WGS84"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># add the distance to the location to the stationlist data frame</span></span>
<span>  <span class="va">stationlist</span><span class="op">$</span><span class="va">Distance_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_distance</a></span><span class="op">(</span><span class="va">stationlist</span>, <span class="va">Location</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># minimum distance is 1 m because</span></span>
<span>  <span class="va">stationlist</span><span class="op">$</span><span class="va">Distance_km</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">stationlist</span><span class="op">$</span><span class="va">Distance_m</span> <span class="op">/</span><span class="fl">1000</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># remove the geometry column</span></span>
<span>  <span class="va">stationlist</span><span class="op">$</span><span class="va">geometry</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">stationlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">stationlist</span><span class="op">)</span></span>
<span>  <span class="va">startdate</span> <span class="op">&lt;-</span> <span class="st">"1990-01-01"</span></span>
<span>  <span class="va">RainStationList</span> <span class="op">&lt;-</span> <span class="va">DWDRain_content</span><span class="op">$</span><span class="va">historical</span><span class="op">$</span><span class="va">stationlist</span></span>
<span>  <span class="co"># select the nearest stations with rain data, for historical data it is necessary to select more than one station</span></span>
<span>  <span class="co"># because stations with rain data changed over time</span></span>
<span>  <span class="va">RainStations_selected</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SelectStations.html">SelectStations</a></span> <span class="op">(</span>lat<span class="op">=</span><span class="va">geoBreite</span>,</span>
<span>                                          long<span class="op">=</span><span class="va">geoLaenge</span>,</span>
<span>                                          height_loc<span class="op">=</span><span class="va">Hoehe_m</span>, </span>
<span>                                          stationlist <span class="op">=</span> <span class="va">RainStationList</span>,</span>
<span>                                          <span class="co">#DWDRain_content$recent$stationlist,</span></span>
<span>                                          minstations<span class="op">=</span><span class="fl">3</span>,</span>
<span>                                          max_stations <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                          radius<span class="op">=</span><span class="fl">80000</span>,</span>
<span>                                          startdate<span class="op">=</span><span class="va">startdate</span>,</span>
<span>                                          max.Height.Distance_m<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># get the rain data for the selected stations</span></span>
<span>  </span>
<span>  <span class="va">df_Rain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GetRainData_selection.html">GetRainData_selection</a></span><span class="op">(</span><span class="va">RainStations_selected</span>,</span>
<span>                                     <span class="va">DWDRain_content</span><span class="op">$</span><span class="va">historical</span>,</span>
<span>                                     repository<span class="op">=</span><span class="va">DWDRain_ftp_historical</span>,</span>
<span>                                     startdate<span class="op">=</span><span class="st">"1990-01-01"</span><span class="op">)</span> </span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># add the distance to the rain station to the data frame</span></span>
<span></span>
<span>  <span class="va">df_Rain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">df_Rain</span>, <span class="va">RainStations_selected</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Stations_id"</span>, <span class="st">"Distance_km"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="st">"Stations_id"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># interpolate the weather data for the location</span></span>
<span>  <span class="va">IntPolDWDHistorical</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/InterpolateFromDWD.html">InterpolateFromDWD</a></span><span class="op">(</span>df_DWD_core <span class="op">=</span> <span class="va">weather_historic_core</span>, stationlist <span class="op">=</span> <span class="va">stationlist</span>, </span>
<span>                                          geoBreite <span class="op">=</span> <span class="va">geoBreite</span>, geoLaenge <span class="op">=</span> <span class="va">geoLaenge</span>, </span>
<span>                                max.Height.Distance_m<span class="op">=</span><span class="fl">100</span>, Hoehe_m <span class="op">=</span> <span class="va">Hoehe_m</span>, df_Rain <span class="op">=</span> <span class="va">df_Rain</span>, </span>
<span>                                startdate <span class="op">=</span> <span class="va">startdate</span><span class="op">)</span> </span>
<span>  <span class="va">IntPolDWDdataHistorical</span> <span class="op">&lt;-</span> <span class="va">IntPolDWDHistorical</span><span class="op">$</span><span class="va">DWDdata</span></span>
<span>  </span>
<span>  <span class="co"># remove the data for the current and previous year as they are in the recent data</span></span>
<span>  <span class="va">ThisYear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">FirstDayOfYear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ThisYear</span><span class="op">-</span><span class="fl">1</span>,<span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">ExcelFirstDayofYear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">FirstDayOfYear</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"1899-12-30"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">IntPolDWDdataHistorical</span> <span class="op">&lt;-</span> <span class="va">IntPolDWDdataHistorical</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Time</span> <span class="op">&lt;</span> <span class="va">ExcelFirstDayofYear</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add longitude and latitude to the data frame</span></span>
<span>  <span class="va">IntPolDWDdataHistorical</span><span class="op">$</span><span class="va">Longitude</span> <span class="op">&lt;-</span> <span class="va">geoLaenge</span></span>
<span>  <span class="va">IntPolDWDdataHistorical</span><span class="op">$</span><span class="va">Latitude</span> <span class="op">&lt;-</span> <span class="va">geoBreite</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">IntPolDWDdataHistorical</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">usedstations</span> <span class="op">&lt;-</span> <span class="va">IntPolDWDHistorical</span><span class="op">$</span><span class="va">df.wf</span></span>
<span>  <span class="va">usedstations</span><span class="op">$</span><span class="va">Distance</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">usedstations</span><span class="op">$</span><span class="va">InvDist</span></span>
<span>  <span class="va">Diststations</span> <span class="op">&lt;-</span> <span class="va">usedstations</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>Distance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Distance</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">Diststations</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="interpolation-of-the-recent-weather-data-for-the-location">Interpolation of the recent weather data for the location<a class="anchor" aria-label="anchor" href="#interpolation-of-the-recent-weather-data-for-the-location"></a>
</h4>
<p>In a next step the recent weather data is interpolated for the
location. Here, the data for the most actual date(s) may be
incomplete.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span>  </span>
<span><span class="co"># recent data #######</span></span>
<span></span>
<span>  <span class="co">## retrieve the recent station list from the DWD content</span></span>
<span>  </span>
<span>  <span class="va">stationlist</span> <span class="op">&lt;-</span> <span class="va">DWDrecent</span><span class="op">$</span><span class="va">stationlist</span></span>
<span></span>
<span>  <span class="co"># make an sf object from stationlist data frame</span></span>
<span>  <span class="va">stationlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">stationlist</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geoLaenge"</span>, <span class="st">"geoBreite"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_set_crs</a></span><span class="op">(</span>value <span class="op">=</span> <span class="st">"+proj=longlat +datum=WGS84"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># add the distance to the location to the stationlist data frame</span></span>
<span>  <span class="va">stationlist</span><span class="op">$</span><span class="va">Distance_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_distance</a></span><span class="op">(</span><span class="va">stationlist</span>, <span class="va">Location</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># minimum distance is 1 m because</span></span>
<span>  <span class="va">stationlist</span><span class="op">$</span><span class="va">Distance_km</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">stationlist</span><span class="op">$</span><span class="va">Distance_m</span> <span class="op">/</span><span class="fl">1000</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="co"># remove the geometry column</span></span>
<span>  <span class="va">stationlist</span><span class="op">$</span><span class="va">geometry</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">stationlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">stationlist</span><span class="op">)</span></span>
<span>  <span class="va">startdate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ThisYear</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,<span class="st">"-01-01"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># select the neart stations with rain data</span></span>
<span>  <span class="va">RainStation_selected</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SelectStations.html">SelectStations</a></span> <span class="op">(</span>lat<span class="op">=</span><span class="va">geoBreite</span>,</span>
<span>                                          long<span class="op">=</span><span class="va">geoLaenge</span>,</span>
<span>                                          height_loc<span class="op">=</span><span class="va">Hoehe_m</span>, </span>
<span>                                          stationlist <span class="op">=</span> <span class="va">RecentRainStationList</span>,</span>
<span>                                          <span class="co">#DWDRain_content$recent$stationlist,</span></span>
<span>                                          minstations<span class="op">=</span><span class="fl">3</span>,</span>
<span>                                          max_stations <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                          radius<span class="op">=</span><span class="fl">80000</span>,</span>
<span>                                          startdate<span class="op">=</span><span class="va">startdate</span>,</span>
<span>                                          max.Height.Distance_m<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># get the rain data for the selected stations</span></span>
<span>  </span>
<span>  <span class="va">df_Rain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GetRainData_selection.html">GetRainData_selection</a></span><span class="op">(</span><span class="va">RainStations_selected</span>,</span>
<span>                                     <span class="va">DWDRain_content</span><span class="op">$</span><span class="va">recent</span>,</span>
<span>                                     repository<span class="op">=</span><span class="va">DWDRain_ftp_recent</span>,</span>
<span>                                     startdate<span class="op">=</span><span class="st">"2023-01-01"</span><span class="op">)</span> </span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># add the distance to the rain station to the data frame</span></span>
<span></span>
<span>  <span class="va">df_Rain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">df_Rain</span>, <span class="va">RainStations_selected</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Stations_id"</span>, <span class="st">"Distance_km"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="st">"Stations_id"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">#</span></span>
<span>  <span class="va">IntpolDWDrecent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/InterpolateFromDWD.html">InterpolateFromDWD</a></span><span class="op">(</span>df_DWD_core <span class="op">=</span> <span class="va">weather_recent</span>, stationlist <span class="op">=</span> <span class="va">stationlist</span>, geoBreite <span class="op">=</span> <span class="va">geoBreite</span>, geoLaenge <span class="op">=</span> <span class="va">geoLaenge</span>, </span>
<span>                                max.Height.Distance_m<span class="op">=</span><span class="fl">100</span>, Hoehe_m <span class="op">=</span> <span class="va">Hoehe_m</span>, df_Rain <span class="op">=</span> <span class="va">df_Rain</span>, </span>
<span>                                startdate <span class="op">=</span> <span class="va">startdate</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="va">IntPolDWDdatarecent</span> <span class="op">&lt;-</span> <span class="va">IntpolDWDrecent</span><span class="op">$</span><span class="va">DWDdata</span></span>
<span> </span>
<span>  </span>
<span>  </span>
<span>  <span class="va">IntPolDWDdatarecent</span><span class="op">$</span><span class="va">Longitude</span> <span class="op">&lt;-</span> <span class="va">geoLaenge</span></span>
<span>  <span class="va">IntPolDWDdatarecent</span><span class="op">$</span><span class="va">Latitude</span> <span class="op">&lt;-</span> <span class="va">geoBreite</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">IntPolDWDdatarecent</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="combine-the-historical-and-recent-data">Combine the historical and recent data<a class="anchor" aria-label="anchor" href="#combine-the-historical-and-recent-data"></a>
</h3>
<p>The data from the historical and recent data is combined in one data
frame.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  </span>
<span>  <span class="va">DWDdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">IntPolDWDdataHistorical</span>, <span class="va">IntPolDWDdatarecent</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">DWDdata</span><span class="op">)</span></span></code></pre></div>
<p>The combined data frame contains r nrow(DWDdata) records and starts
at r as.Date(min(DWDdata<span class="math inline">$Time),origin =
"1899-12-30" )` and ends at
r as.Date(max(DWDdata$</span>Time),origin = “1899-12-30” ).</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Henning Kage.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
